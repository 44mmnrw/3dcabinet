<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ModelSceneManager + TS_700_500_250 - Test</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: Arial, sans-serif; }
        canvas { display: block; }
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 350px;
        }
        #controls {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(255,255,255,0.95);
            padding: 15px;
            border-radius: 8px;
            font-size: 11px;
        }
        button {
            margin: 5px 0;
            padding: 8px 12px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #3498db;
            color: white;
            font-size: 11px;
            width: 100%;
        }
        button:hover { background: #2980b9; }
        .input-group {
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
        }
        .input-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 10px;
        }
        input[type="number"] {
            width: 60px;
            padding: 4px;
            margin-right: 5px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div id="info">
        <strong>‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...</strong>
    </div>
    
    <div id="controls">
        <strong>üéÆ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏</strong>
        
        <div class="input-group">
            <label>üö™ Door Position:</label>
            <input type="number" id="doorX" value="-0.4" step="0.05"> X<br>
            <input type="number" id="doorY" value="0" step="0.05"> Y<br>
            <input type="number" id="doorZ" value="0" step="0.05"> Z<br>
            <button onclick="updateDoorPosition()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        
        <div class="input-group">
            <label>üìã Panel Position:</label>
            <input type="number" id="panelX" value="0" step="0.05"> X<br>
            <input type="number" id="panelY" value="0" step="0.05"> Y<br>
            <input type="number" id="panelZ" value="-0.25" step="0.05"> Z<br>
            <button onclick="updatePanelPosition()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        
        <div class="input-group">
            <label>‚ö° DIN Rail Position:</label>
            <input type="number" id="dinX" value="-0.15" step="0.05"> X<br>
            <input type="number" id="dinY" value="0.2" step="0.05"> Y<br>
            <input type="number" id="dinZ" value="0" step="0.05"> Z<br>
            <button onclick="updateDinRailPosition()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
        
        <button onclick="toggleDoor()">üîÑ –ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å Door</button>
        <button onclick="showInfo()">üìä –ü–æ–∫–∞–∑–∞—Ç—å Info</button>
    </div>

    <script type="module">
        import * as THREE from './js/libs/three.module.js';
        import { OrbitControls } from './js/libs/OrbitControls.js';
        import { ModelSceneManager } from './js/modules/ModelSceneManager.js';
        import { test_TS_700_500_250 } from './js/models/TS_700_500_250/test_TS_700_500_250.js';
        
        console.clear();
        console.log('üöÄ ModelSceneManager + test_TS_700_500_250 Test (–¢–µ—Å—Ç–æ–≤–∞—è –º–æ–¥–µ–ª—å)');
        
        // –°—Ü–µ–Ω–∞
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);
        
        // –ö–∞–º–µ—Ä–∞
        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(1.5, 1, 1.5);
        
        // –†–µ–Ω–¥–µ—Ä–µ—Ä
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        // –ö–æ–Ω—Ç—Ä–æ–ª–ª—ã
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.target.set(0, 0.5, 0);
        
        // –°–≤–µ—Ç
        scene.add(new THREE.AmbientLight(0xffffff, 0.6));
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.4);
        dirLight.position.set(5, 10, 5);
        scene.add(dirLight);
        
        // –°–µ—Ç–∫–∞
        scene.add(new THREE.GridHelper(2, 10));
        scene.add(new THREE.AxesHelper(0.5));
        
        // ========================================
        // –ì–õ–ê–í–ù–ê–Ø –ß–ê–°–¢–¨: –ò—Å–ø–æ–ª—å–∑—É–µ–º ModelSceneManager
        // ========================================
        
        const sceneManager = new ModelSceneManager(scene);
        const MODEL_ID = 'cabinet-1';
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ ModelSceneManager
        (async function() {
            try {
                const assembler = new test_TS_700_500_250();
                
                // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–µ–ª—å —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂–µ—Ä —Å—Ü–µ–Ω—ã
                await sceneManager.addModel(
                    MODEL_ID,
                    assembler,
                    { x: 0, y: 0, z: 0 },
                    {
                        basePath: './assets/models/freecad',
                        size: '700_500_250',
                        name: 'Main Cabinet'
                    }
                );
                
                console.log('\n‚úÖ –ú–æ–¥–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ ModelSceneManager!');
                console.log('üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ü–µ–Ω–µ:', sceneManager.getInfo());
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –∏–Ω–ø—É—Ç—ã
                updateInfoDisplay();
                syncInputsFromModel();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞:', error);
                document.getElementById('info').innerHTML = `
                    <strong style="color:red;">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!</strong><br>
                    ${error.message}
                `;
            }
        })();
        
        // ========================================
        // API –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ UI
        // ========================================
        
        window.updateDoorPosition = function() {
            const x = parseFloat(document.getElementById('doorX').value);
            const y = parseFloat(document.getElementById('doorY').value);
            const z = parseFloat(document.getElementById('doorZ').value);
            
            sceneManager.setComponentPosition(MODEL_ID, 'door', x, y, z);
            updateInfoDisplay();
        };
        
        window.updatePanelPosition = function() {
            const x = parseFloat(document.getElementById('panelX').value);
            const y = parseFloat(document.getElementById('panelY').value);
            const z = parseFloat(document.getElementById('panelZ').value);
            
            sceneManager.setComponentPosition(MODEL_ID, 'panel', x, y, z);
            updateInfoDisplay();
        };
        
        window.updateDinRailPosition = function() {
            const x = parseFloat(document.getElementById('dinX').value);
            const y = parseFloat(document.getElementById('dinY').value);
            const z = parseFloat(document.getElementById('dinZ').value);
            
            sceneManager.setComponentPosition(MODEL_ID, 'dinRail', x, y, z);
            updateInfoDisplay();
        };
        
        window.toggleDoor = function() {
            const model = sceneManager.models.get(MODEL_ID);
            if (model) {
                const door = model.assembler.getComponents().door;
                if (door) {
                    model.assembler.setComponentVisibility('door', !door.visible);
                }
            }
        };
        
        window.showInfo = function() {
            const info = sceneManager.getInfo();
            console.log('üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ü–µ–Ω–µ:');
            console.log(JSON.stringify(info, null, 2));
        };
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–Ω–ø—É—Ç–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ –º–æ–¥–µ–ª–∏
        function syncInputsFromModel() {
            const model = sceneManager.models.get(MODEL_ID);
            if (!model) return;
            
            const assembler = model.assembler;
            
            const doorPos = assembler.getComponentPosition('door');
            const panelPos = assembler.getComponentPosition('panel');
            const dinPos = assembler.getComponentPosition('dinRail');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º value –∏–Ω–ø—É—Ç–æ–≤
            document.getElementById('doorX').value = doorPos.x.toFixed(2);
            document.getElementById('doorY').value = doorPos.y.toFixed(2);
            document.getElementById('doorZ').value = doorPos.z.toFixed(2);
            
            document.getElementById('panelX').value = panelPos.x.toFixed(2);
            document.getElementById('panelY').value = panelPos.y.toFixed(2);
            document.getElementById('panelZ').value = panelPos.z.toFixed(2);
            
            document.getElementById('dinX').value = dinPos.x.toFixed(2);
            document.getElementById('dinY').value = dinPos.y.toFixed(2);
            document.getElementById('dinZ').value = dinPos.z.toFixed(2);
        }
        
        function updateInfoDisplay() {
            const model = sceneManager.models.get(MODEL_ID);
            if (!model) return;
            
            const assembler = model.assembler;
            
            const bodyPos = assembler.getComponentPosition('body');
            const doorPos = assembler.getComponentPosition('door');
            const panelPos = assembler.getComponentPosition('panel');
            const dinPos = assembler.getComponentPosition('dinRail');
            
            const bodyWorld = assembler.getComponentWorldPosition('body');
            const doorWorld = assembler.getComponentWorldPosition('door');
            const panelWorld = assembler.getComponentWorldPosition('panel');
            const dinWorld = assembler.getComponentWorldPosition('dinRail');
            
            document.getElementById('info').innerHTML = `
                <strong>‚úÖ –®–∫–∞—Ñ —Å–æ–±—Ä–∞–Ω!</strong><br>
                <small>–ò—Å–ø–æ–ª—å–∑—É–π –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–π</small><br><br>
                
                <strong>üìç –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (local / world):</strong><br>
                <small>
                <strong>Body:</strong><br>
                L: (${bodyPos.x.toFixed(3)}, ${bodyPos.y.toFixed(3)}, ${bodyPos.z.toFixed(3)})<br>
                W: (${bodyWorld.x.toFixed(3)}, ${bodyWorld.y.toFixed(3)}, ${bodyWorld.z.toFixed(3)})<br><br>
                
                <strong>Door:</strong><br>
                L: (${doorPos.x.toFixed(3)}, ${doorPos.y.toFixed(3)}, ${doorPos.z.toFixed(3)})<br>
                W: (${doorWorld.x.toFixed(3)}, ${doorWorld.y.toFixed(3)}, ${doorWorld.z.toFixed(3)})<br><br>
                
                <strong>Panel:</strong><br>
                L: (${panelPos.x.toFixed(3)}, ${panelPos.y.toFixed(3)}, ${panelPos.z.toFixed(3)})<br>
                W: (${panelWorld.x.toFixed(3)}, ${panelWorld.y.toFixed(3)}, ${panelWorld.z.toFixed(3)})<br><br>
                
                <strong>DIN_Rail:</strong><br>
                L: (${dinPos.x.toFixed(3)}, ${dinPos.y.toFixed(3)}, ${dinPos.z.toFixed(3)})<br>
                W: (${dinWorld.x.toFixed(3)}, ${dinWorld.y.toFixed(3)}, ${dinWorld.z.toFixed(3)})
                </small>
            `;
        }
        
        // –ê–Ω–∏–º–∞—Ü–∏—è
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();
        
        // Resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
